local function createNameTag(character)
    local head = character:FindFirstChild("Head")
    if head then
        local billboardGui = Instance.new("BillboardGui")
        billboardGui.Adornee = head
        billboardGui.Size = UDim2.new(0, 50, 0, 50)  -- Adjust size as needed
        billboardGui.StudsOffset = Vector3.new(0, 3, 0)  -- Adjust the offset as needed
        billboardGui.AlwaysOnTop = true
        billboardGui.Parent = head

        local textLabel = Instance.new("TextLabel")
        textLabel.Text = character.Name
        textLabel.TextColor3 = Color3.fromRGB(math.random(0, 255), math.random(0, 255), math.random(0, 255))  -- Random color per player
        textLabel.TextStrokeTransparency = 0.8
        textLabel.TextSize = 10  -- Smaller text size
        textLabel.BackgroundTransparency = 1
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Parent = billboardGui
    end
end

local function addESPToCharacter(character)
    createNameTag(character)
    local highlight = Instance.new("Highlight")
    highlight.Adornee = character
    highlight.Parent = character
    highlight.FillColor = Color3.fromRGB(0, 0, 0) -- No fill color
    highlight.OutlineColor = Color3.fromRGB(math.random(0, 255), math.random(0, 255), math.random(0, 255)) -- Random outline color per player
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- Ensure it shows through walls
end

local function onChatMessage(player, message)
    local command, arg = message:match("^(%S+)%s*(.*)")

    if command == "!teleport" then
        -- Execute teleport command
        print(player.Name .. " wants to teleport to " .. arg)
        local targetPlayer
        for _, p in ipairs(game.Players:GetPlayers()) do
            if p.Name:lower():find(arg:lower()) then
                targetPlayer = p
                break
            end
        end
        
        if targetPlayer and targetPlayer.Character then
            local targetCharacter = targetPlayer.Character
            local character = player.Character
            if character then
                local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                local targetHumanoidRootPart = targetCharacter:FindFirstChild("HumanoidRootPart")
                if humanoidRootPart and targetHumanoidRootPart then
                    humanoidRootPart.CFrame = targetHumanoidRootPart.CFrame
                end
            end
        else
            -- Notify player if target is not found
            print("Error: Player not found!")
            -- Replace with actual error notification if available
            -- player:SendNotification({Title = "Error", Text = "Player not found!"})
        end

    elseif command == "!esp" then
        -- Execute ESP command
        print(player.Name .. " wants to enable ESP.")
        -- Apply ESP to all current players
        for _, targetPlayer in ipairs(game.Players:GetPlayers()) do
            if targetPlayer ~= player and targetPlayer.Character then
                addESPToCharacter(targetPlayer.Character)
            end
            -- Connect CharacterAdded to add ESP to new characters
            targetPlayer.CharacterAdded:Connect(function(character)
                addESPToCharacter(character)
            end)
        end

    -- Add more commands as needed
    end
end

-- Listen for PlayerAdded event
game.Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(message)
        onChatMessage(player, message)
    end)
    -- Connect CharacterAdded to add ESP to the new player's character
    player.CharacterAdded:Connect(function(character)
        addESPToCharacter(character)
    end)
end)

-- For players who are already in the game
for _, player in ipairs(game.Players:GetPlayers()) do
    player.Chatted:Connect(function(message)
        onChatMessage(player, message)
    end)
    -- Connect CharacterAdded to add ESP to existing players
    player.CharacterAdded:Connect(function(character)
        addESPToCharacter(character)
    end)
end
