-- Function to enable fly
local function enableFly(player)
    local character = player.Character
    if character then
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        local camera = workspace.CurrentCamera
        if humanoidRootPart then
            local flying = true
            local flySpeed = 50 -- Speed of the flying movement
            local flyConnection

            -- Update CFrame based on player's look direction
            flyConnection = game:GetService("RunService").RenderStepped:Connect(function()
                if flying and humanoidRootPart then
                    local lookDirection = camera.CFrame.LookVector
                    local moveDirection = Vector3.new(
                        lookDirection.X,
                        0,
                        lookDirection.Z
                    ).unit
                    local targetCFrame = humanoidRootPart.CFrame + (moveDirection * flySpeed * 0.1)
                    humanoidRootPart.CFrame = CFrame.new(targetCFrame.Position, targetCFrame.Position + lookDirection)
                end
            end)

            -- Stop flying when the player's character dies
            player.Character.Humanoid.Died:Connect(function()
                flying = false
                flyConnection:Disconnect()
            end)
        end
    end
end

-- Function to handle chat commands
local function onChatMessage(player, message)
    local command, arg = message:match("^(%S+)%s*(.*)")

    if command == "!fly" then
        -- Execute fly command
        print(player.Name .. " wants to fly.")
        enableFly(player)

    elseif command == "!teleport" then
        -- Execute teleport command
        print(player.Name .. " wants to teleport to " .. arg)
        local targetPlayer
        for _, p in ipairs(game.Players:GetPlayers()) do
            if string.lower(p.Name):sub(1, #arg) == string.lower(arg) then
                targetPlayer = p
                break
            end
        end

        if targetPlayer and targetPlayer.Character then
            local targetCharacter = targetPlayer.Character
            local character = player.Character
            if character then
                local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
                local targetHumanoidRootPart = targetCharacter:FindFirstChild("HumanoidRootPart")
                if humanoidRootPart and targetHumanoidRootPart then
                    humanoidRootPart.CFrame = targetHumanoidRootPart.CFrame
                end
            end
        end

    elseif command == "!esp" then
        -- Execute ESP command
        print(player.Name .. " wants to enable ESP.")
        for _, targetPlayer in ipairs(game.Players:GetPlayers()) do
            if targetPlayer ~= player and targetPlayer.Character then
                local character = targetPlayer.Character
                local head = character:FindFirstChild("Head")
                if head then
                    -- Remove existing ESP components
                    for _, v in pairs(head:FindAllChildren()) do
                        if v:IsA("BillboardGui") or v:IsA("Highlight") then
                            v:Destroy()
                        end
                    end

                    -- Add highlight
                    local highlight = Instance.new("Highlight")
                    highlight.Adornee = character
                    highlight.FillColor = Color3.fromRGB(255, 0, 0) -- Red fill color
                    highlight.OutlineColor = Color3.fromRGB(255, 255, 255) -- White outline color
                    highlight.Parent = character

                    -- Add BillboardGui for name display
                    local billboardGui = Instance.new("BillboardGui")
                    billboardGui.Adornee = head
                    billboardGui.Size = UDim2.new(0, 100, 0, 50)
                    billboardGui.StudsOffset = Vector3.new(0, 2, 0)
                    billboardGui.AlwaysOnTop = true

                    local textLabel = Instance.new("TextLabel")
                    textLabel.Text = targetPlayer.Name
                    textLabel.Size = UDim2.new(1, 0, 1, 0)
                    textLabel.TextColor3 = Color3.fromRGB(255, 0, 0) -- Red text color
                    textLabel.BackgroundTransparency = 1
                    textLabel.TextScaled = true
                    textLabel.Font = Enum.Font.SourceSans

                    textLabel.Parent = billboardGui
                    billboardGui.Parent = head
                end
            end
        end
    end
end

-- Listen for PlayerAdded event
game.Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(message)
        onChatMessage(player, message)
    end)
end)

-- For players who are already in the game
for _, player in ipairs(game.Players:GetPlayers()) do
    player.Chatted:Connect(function(message)
        onChatMessage(player, message)
    end)
end
